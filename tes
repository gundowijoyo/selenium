from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
import time
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class FormAutomation:
    def __init__(self, url, form_data):

        self.url = url
        self.form_data = form_data
        self.driver = None
        
    def setup_driver(self):
        chrome_options = Options()

        self.driver = webdriver.Chrome(options=chrome_options)
        self.driver.set_page_load_timeout(60)
        
    def check_form_exists(self):
        try:
            WebDriverWait(self.driver, 2).until(
                EC.presence_of_element_located((By.NAME, "name"))
            )
            return True
        except:
            return False
    
    def navigate_form_found(self):
        try:
            self.driver.get(self.url)
            
            if self.check_form_exists():
                logger.info(f"Form found!")
                return True
            else:
                logger.warning(f" Form not found")
                time.sleep(0.1) 
                
        except Exception as e:
            logger.error(f"Error : {str(e)}")
            time.sleep(0.1)
        return False
    
    def extract_captcha(self):
        try:
            captcha_element = WebDriverWait(self.driver, 5).until(
                EC.presence_of_element_located((By.ID, "captcha-box"))
            )
            captcha_text = captcha_element.text.strip()
            logger.info(f"Captcha extracted: {captcha_text}")
            return captcha_text
        except Exception as e:
            logger.error(f"Failed to extract captcha: {str(e)}")
            return None
    
    def fill_form(self):
        try:
            name_field = self.driver.find_element(By.ID, "name")
            name_field.clear()
            name_field.send_keys(self.form_data['name'])
            logger.info(f" Filled name: {self.form_data['name']}")
            

            ktp_field = self.driver.find_element(By.ID, "ktp")
            ktp_field.clear()
            ktp_field.send_keys(self.form_data['ktp'])
            logger.info(f" Filled KTP: {self.form_data['ktp']}")
            

            phone_field = self.driver.find_element(By.ID, "phone_number")
            phone_field.clear()
            phone_field.send_keys(self.form_data['phone_number'])
            logger.info(f" Filled phone: {self.form_data['phone_number']}")
            

            check1 = self.driver.find_element(By.ID, "check")
            if not check1.is_selected():

                check1.click()
            if check1.is_selected():
                logger.info(" Checked first checkbox")
            
 
            check2 = self.driver.find_element(By.ID, "check_2")
            if not check2.is_selected():

                check2.click()
            
            if check2.is_selected():
                logger.info(" Checked second checkbox")

            captcha_text = self.extract_captcha()
            if captcha_text:
                captcha_input = self.driver.find_element(By.ID, "captcha_input")
                captcha_input.clear()
                captcha_input.send_keys(captcha_text)
                logger.info(f" Filled captcha: {captcha_text}")
            else:
                logger.error(" Failed to extract captcha")
                return False
            
            return True
            
        except Exception as e:
            logger.error(f"Error filling form: {str(e)}")
            return False
    
    def submit_form(self):

        try:
            submit_button = WebDriverWait(self.driver, 5).until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, "button[type='submit']"))
            )
            submit_button.click()
            logger.info("Form submitted!")
            
            time.sleep(1)
            return True
            
        except Exception as e:
            logger.error(f"Error submitting form: {str(e)}")
            return False
    
    def run(self):

        try:
            logger.info("Starting automation...")
            self.setup_driver()
            

            if not self.navigate_form_found():
                logger.error("Could not find form. Exiting.")
                return False
            
            if not self.fill_form():
                logger.error("Failed to fill form. Exiting.")
                return False
            

            if not self.submit_form():
                logger.error("Failed to submit form. Exiting.")
                return False
            
            logger.info("Automation completed successfully!")

            input("Press Enter to close browser...")
            return True
            
        except Exception as e:
            logger.error(f"Unexpected error: {str(e)}")
            return False
            
        finally:
            if self.driver:
                self.driver.quit()
                logger.info("Browser closed")



if __name__ == "__main__":

    TARGET_URL = "https://antributikbekasi.com"

    form_data = {
        'name': "name",  
        'ktp': "ktp",  
        'phone_number': "phone_number"
    }
    
    print(form_data)
    bot = FormAutomation(TARGET_URL, form_data)
    success = bot.run()
    
    if success:
        print("\n SUCCESS! Form submitted successfully")
    else:
        print("\n FAILED! Check logs for details")
